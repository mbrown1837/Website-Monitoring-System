{% extends 'layout.html' %}

{% block title %}History for {{ website.name }} - Website Monitor{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* Add custom styles for the history page here */
    .history-table th, .history-table td {
        vertical-align: middle;
    }
    .screenshot-thumbnail {
        max-width: 200px;
        height: auto;
        border-radius: 5px;
        cursor: pointer;
        transition: transform 0.2s;
    }
    .screenshot-thumbnail:hover {
        transform: scale(1.05);
    }
    .baseline-gallery {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
    }
    .baseline-item {
        text-align: center;
    }
    .baseline-item .screenshot-thumbnail {
        max-width: 150px;
    }
    .modal-dialog-centered {
        display: flex;
        align-items: center;
        min-height: calc(100% - 1rem);
    }
    .modal-lg {
        max-width: 80%;
    }
    .modal-body img {
        max-width: 100%;
        height: auto;
    }
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.75);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        color: white;
        flex-direction: column;
    }
    .loader {
        border: 8px solid #f3f3f3;
        border-radius: 50%;
        border-top: 8px solid #3498db;
        width: 60px;
        height: 60px;
        animation: spin 1.5s linear infinite;
    }
    #loading-overlay p {
        margin-top: 20px;
        font-size: 1.2rem;
        letter-spacing: 1px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .toast-container {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 10001;
    }
    .toast {
        min-width: 300px;
    }
</style>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ website.name }} History</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div id="loading-overlay">
    <div class="loader"></div>
    <p>Processing your request...</p>
</div>

<!-- Toast Notification Container -->
<div class="toast-container"></div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>History for <a href="{{ website.url }}" target="_blank">{{ website.name }}</a></h2>
    <div>
        <a href="{{ url_for('edit_website', site_id=website.id) }}" class="btn btn-outline-primary">
            <i class="bi bi-pencil"></i> Edit Website
        </a>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0">Website Information</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <tr>
                        <th style="width: 150px;">URL:</th>
                        <td><a href="{{ website.url }}" target="_blank">{{ website.url }}</a></td>
            </tr>
                    <tr>
                        <th>Status:</th>
                        <td>
                            {% if website.is_active %}
                                <span class="badge bg-success">Active</span>
                    {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                    {% endif %}
                </td>
                    </tr>
                    <tr>
                        <th>Monitoring Interval:</th>
                        <td>{{ website.interval }} hours</td>
                    </tr>
                    <tr>
                        <th>Last Checked:</th>
                        <td>{{ (history[0].get('timestamp') if history and history[0] else website.last_checked_utc) | humanize_datetime }}</td>
                    </tr>
                    <tr>
                        <th>Baseline Created:</th>
                        <td>
                            {% if website.baseline_visual_path %}
                                <span class="text-success">
                                    <i class="bi bi-check-circle"></i> 
                                    {{ website.baseline_captured_utc | humanize_datetime if website.baseline_captured_utc else 'Previously' }}
                                </span>
                        {% else %}
                                <span class="text-warning">
                                    <i class="bi bi-exclamation-triangle"></i> No baseline created yet
                                </span>
                                <small class="text-muted d-block">Use "Create/Update Baseline" button below to create one</small>
                    {% endif %}
                </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" id="checkNowBtn">
                        <i class="bi bi-play-circle"></i> Run Full Check Now
                    </button>
                    
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary" id="visualCheckBtn">
                            <i class="bi bi-eye"></i> Visual Check Only
                        </button>
                        <button class="btn btn-outline-secondary" id="crawlCheckBtn">
                            <i class="bi bi-search"></i> Crawl Check Only
                        </button>
                        <button class="btn btn-outline-secondary" id="blurCheckBtn">
                            <i class="bi bi-image"></i> Blur Check Only
                        </button>
                        <button class="btn btn-outline-secondary" id="performanceCheckBtn">
                            <i class="bi bi-speedometer2"></i> Performance Check
                        </button>
                        <button class="btn btn-outline-success" id="createBaselineBtn">
                            <i class="bi bi-camera"></i> Create/Update Baseline
                        </button>
                    </div>
                    
                    {% if history %}
                    <a href="#historySection" class="btn btn-outline-info">
                        <i class="bi bi-clock-history"></i> View Change History
                    </a>
                    {% endif %}
                    
                    <a href="{{ url_for('website_summary', site_id=website.id) }}" class="btn btn-outline-primary">
                        <i class="bi bi-bar-chart"></i> View Site Summary
                    </a>
                    
                    <hr>
                    <h6 class="text-muted mb-2">View Results</h6>
                    
                    <div class="btn-group w-100 mb-2">
                        <a href="{{ url_for('website_crawler', site_id=website.id) }}" class="btn btn-outline-info">
                            <i class="bi bi-search"></i> Crawl Results
                        </a>
                        <a href="{{ url_for('website_missing_meta_tags', site_id=website.id) }}" class="btn btn-outline-warning">
                            <i class="bi bi-tags"></i> Meta Tags
                        </a>
                    </div>
                    
                    <div class="btn-group w-100">
                        {% if website.auto_blur_enabled or website.enable_blur_detection %}
                        <a href="{{ url_for('website_blur_detection', site_id=website.id) }}" class="btn btn-outline-secondary">
                            <i class="bi bi-image"></i> Blur Results
                        </a>
                        {% endif %}
                        {% if website.auto_performance_enabled %}
                        <a href="{{ url_for('website_performance', site_id=website.id) }}" class="btn btn-outline-success">
                            <i class="bi bi-speedometer2"></i> Performance
                        </a>
                        {% endif %}
                    </div>
                    
                    {% if website.baseline_visual_path %}
                    <hr>
                    <a href="#baselineSection" class="btn btn-outline-success">
                        <i class="bi bi-image"></i> View Baselines
                    </a>
                                {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% if website.baseline_visual_path %}
<div class="card mb-4" id="baselineSection">
    <div class="card-header bg-light">
        <h5 class="mb-0">Baseline Screenshots</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header">Main Page Baseline</div>
                    <div class="card-body text-center">
                        <a href="#" class="baseline-link" data-bs-toggle="modal" data-bs-target="#imageModal" data-image-url="{{ url_for('data_files', filepath=website.baseline_visual_path_web) }}" data-page-url="{{ website.url }}">
                            <img src="{{ url_for('data_files', filepath=website.baseline_visual_path_web) }}" 
                                 class="img-fluid img-thumbnail" alt="Baseline Screenshot" 
                                 style="max-height: 300px;"
                                 onerror="this.onerror=null;this.src='{{ url_for('static', filename='img/placeholder.png') }}';">
                        </a>
                    </div>
                    <div class="card-footer text-muted">
                        Captured {{ website.baseline_captured_utc | humanize_datetime if website.baseline_captured_utc else 'previously' }}
                    </div>
                </div>
            </div>
            
            {% if subpage_baselines and subpage_baselines|length > 0 %}
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header">
                        Subpage Baselines ({{ subpage_baselines|length }})
                    </div>
                    <div class="card-body" style="max-height: 350px; overflow-y: auto;">
                        <div class="list-group">
                            {% for baseline in subpage_baselines %}
                            <a href="#" class="list-group-item list-group-item-action baseline-link" data-bs-toggle="modal" data-bs-target="#imageModal" data-image-url="{{ url_for('data_files', filepath=baseline.path_web) }}" data-page-url="{{ baseline.url }}">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">
                                        <i class="bi bi-file-earmark-text"></i> 
                                        {{ baseline.url | replace(website.url, '') | truncate(40, True) or '/' }}
                                    </h6>
                                    <small>{{ baseline.timestamp | humanize_datetime }}</small>
                                </div>
                                <small class="text-muted">{{ baseline.url | truncate(60) }}</small>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
                                {% endif %}
        </div>
    </div>
</div>
                                {% endif %}
                                
{% if history %}
<div class="card mb-4" id="historySection">
    <div class="card-header bg-light">
        <h5 class="mb-0">Change History</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th scope="col" style="width: 15%;">Timestamp</th>
                        <th scope="col">Status</th>
                        <th scope="col" style="width: 15%;">Visual Change</th>
                        <th scope="col">Snapshots</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in history %}
                    <tr>
                        <td>{{ item.timestamp | humanize_datetime }}</td>
                        <td>
                            {% if item.status == 'completed' %}
                                <span class="badge bg-success">Completed</span>
                            {% else %}
                                <span class="badge bg-secondary">In Progress</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.visual_diff_percent is defined %}
                                {% set diff_percent = item.visual_diff_percent %}
                                {% if diff_percent > config.get('visual_change_alert_threshold_percent', 0.01) %}
                                    <span class="badge bg-danger">{{ "%.2f"|format(diff_percent) }}%</span>
                                {% elif diff_percent > 0 %}
                                    <span class="badge bg-warning">{{ "%.2f"|format(diff_percent) }}%</span>
                                {% else %}
                                    <span class="badge bg-success">No change</span>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-secondary">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.latest_visual_snapshot_path_web %}
                                <a href="#" class="baseline-link" data-bs-toggle="modal" data-bs-target="#imageModal" data-image-url="{{ url_for('data_files', filepath=item.latest_visual_snapshot_path_web) }}" data-page-url="{{ item.url }}">
                                    Latest
                                </a>
                            {% endif %}
                            {% if item.visual_diff_image_path_web %}
                                | <a href="#" class="baseline-link" data-bs-toggle="modal" data-bs-target="#imageModal" data-image-url="{{ url_for('data_files', filepath=item.visual_diff_image_path_web) }}" data-page-url="{{ item.url }}">
                                    Diff
                                </a>
                    {% endif %}
                </td>
            </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center text-muted">No history available for this website yet.</td>
                    </tr>
            {% endfor %}
        </tbody>
    </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Universal Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Screenshot Preview</h5>
                <a href="#" id="modalPageLink" target="_blank" class="btn btn-outline-primary ms-3">
                    <i class="bi bi-box-arrow-up-right"></i> Go to Page
                </a>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img src="" class="img-fluid" alt="Screenshot" id="modalImage">
                </div>
        </div>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toast notification function
    function showToast(title, message, type = 'info') {
        // Create toast container if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast element
        const toastId = 'toast-' + Date.now();
        const bgClass = type === 'success' ? 'bg-success' : type === 'danger' ? 'bg-danger' : type === 'warning' ? 'bg-warning' : 'bg-info';
        
        const toastHTML = `
            <div id="${toastId}" class="toast ${bgClass} text-white" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">${title}</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        
        // Show toast
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, {
            autohide: true,
            delay: 5000
        });
        toast.show();
        
        // Remove toast element after it's hidden
        toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
        });
    }
    
    // Make showToast available globally
    window.showToast = showToast;
    // Universal Image Modal Handler
    const imageModal = document.getElementById('imageModal');
    imageModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const imageUrl = button.getAttribute('data-image-url');
        const pageUrl = button.getAttribute('data-page-url');

        const modalImage = imageModal.querySelector('#modalImage');
        modalImage.src = imageUrl;

        const modalTitle = imageModal.querySelector('#imageModalLabel');
        const pageLink = imageModal.querySelector('#modalPageLink');

        if (pageUrl) {
            pageLink.href = pageUrl;
            pageLink.style.display = 'block';
            modalTitle.textContent = `Screenshot for ${pageUrl}`;
            } else {
            pageLink.style.display = 'none';
            modalTitle.textContent = 'Screenshot Preview';
        }
    });

    const checkNowBtn = document.getElementById('checkNowBtn');
    const visualCheckBtn = document.getElementById('visualCheckBtn');
    const crawlCheckBtn = document.getElementById('crawlCheckBtn');
    const blurCheckBtn = document.getElementById('blurCheckBtn');
    const performanceCheckBtn = document.getElementById('performanceCheckBtn');
    const createBaselineBtn = document.getElementById('createBaselineBtn');
    
    if (checkNowBtn) {
        checkNowBtn.addEventListener('click', function() {
            // Show loading state
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Checking...';
            this.disabled = true;
            
            // Send AJAX request
            fetch('{{ url_for("manual_check_website", site_id=website.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: 'check_type=full'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Check initiated:', data);
                
                // Show success message
                showToast('Full check initiated. This may take a few moments.', 'success');
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    this.innerHTML = '<i class="bi bi-play-circle"></i> Run Full Check Now';
                    this.disabled = false;
                }, 3000);
            })
            .catch(error => {
                console.error('Error:', error);
                this.innerHTML = '<i class="bi bi-play-circle"></i> Run Full Check Now';
                this.disabled = false;
                showToast('Error', 'Error initiating check. Please try again.', 'danger');
            });
        });
    }
    
    if (visualCheckBtn) {
        visualCheckBtn.addEventListener('click', function() {
            // Show loading state
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Checking...';
            this.disabled = true;
            
            // Send AJAX request
            fetch('{{ url_for("manual_check_website", site_id=website.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: 'check_type=visual'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Visual check initiated:', data);
                
                // Show success message
                showToast('Visual check initiated. This may take a few moments.', 'success');
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    this.innerHTML = '<i class="bi bi-eye"></i> Visual Check Only';
                    this.disabled = false;
                }, 3000);
            })
            .catch(error => {
                console.error('Error:', error);
                this.innerHTML = '<i class="bi bi-eye"></i> Visual Check Only';
                this.disabled = false;
                showToast('Error', 'Error initiating visual check. Please try again.', 'danger');
            });
        });
    }
    
    if (crawlCheckBtn) {
        crawlCheckBtn.addEventListener('click', function() {
            // Show loading state
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Checking...';
            this.disabled = true;
            
            // Send AJAX request
            fetch('{{ url_for("manual_check_website", site_id=website.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: 'check_type=crawl'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Crawl check initiated:', data);
                
                // Show success message
                showToast('Crawl check initiated. This may take a few moments.', 'success');
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    this.innerHTML = '<i class="bi bi-search"></i> Crawl Check Only';
                    this.disabled = false;
                }, 3000);
            })
            .catch(error => {
                console.error('Error:', error);
                this.innerHTML = '<i class="bi bi-search"></i> Crawl Check Only';
                this.disabled = false;
                showToast('Error', 'Error initiating crawl check. Please try again.', 'danger');
            });
        });
    }
    
    if (blurCheckBtn) {
        blurCheckBtn.addEventListener('click', function() {
            // Show loading state
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Checking...';
            this.disabled = true;
            
            // Send AJAX request
            fetch('{{ url_for("manual_check_website", site_id=website.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: 'check_type=blur'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Blur check initiated:', data);
                
                // Show success message
                showToast('Blur check initiated. This may take a few moments.', 'success');
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    this.innerHTML = '<i class="bi bi-image"></i> Blur Check Only';
                    this.disabled = false;
                }, 3000);
            })
            .catch(error => {
                console.error('Error:', error);
                this.innerHTML = '<i class="bi bi-image"></i> Blur Check Only';
                this.disabled = false;
                showToast('Error', 'Error initiating blur check. Please try again.', 'danger');
            });
        });
    }

    if (performanceCheckBtn) {
        performanceCheckBtn.addEventListener('click', function() {
            // Show loading state
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Checking...';
            this.disabled = true;
            
            // Send AJAX request
            fetch('{{ url_for("manual_check_website", site_id=website.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: 'check_type=performance'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Performance check response:', data);
                if (data.status === 'initiated') {
                    // Show success message
                    alert('Performance check initiated. This may take a few moments.');
                    
                    // Reset button after 3 seconds
                    setTimeout(() => {
                        this.innerHTML = '<i class="bi bi-speedometer2"></i> Performance Check';
                        this.disabled = false;
                    }, 3000);
                } else {
                    this.innerHTML = '<i class="bi bi-speedometer2"></i> Performance Check';
                    this.disabled = false;
                    alert('Error starting performance check: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Performance check error:', error);
                this.innerHTML = '<i class="bi bi-speedometer2"></i> Performance Check';
                this.disabled = false;
                alert('Error starting performance check. Please try again.');
            });
        });
    }
    
    if (createBaselineBtn) {
        createBaselineBtn.addEventListener('click', function() {
            // Show loading state
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Creating...';
            this.disabled = true;
            
            // Send AJAX request for baseline creation
            fetch('{{ url_for("manual_check_website", site_id=website.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: 'create_baseline=true&capture_subpages=true'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Baseline creation initiated:', data);
                
                // Show success message
                showToast('Baseline creation initiated. This may take a few moments.', 'success');
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    this.innerHTML = '<i class="bi bi-camera"></i> Create/Update Baseline';
                    this.disabled = false;
                }, 3000);
            })
            .catch(error => {
                console.error('Error:', error);
                this.innerHTML = '<i class="bi bi-camera"></i> Create/Update Baseline';
                this.disabled = false;
                showToast('Error', 'Error creating baseline. Please try again.', 'danger');
            });
        });
    }



    function pollStatus(taskId) {
        const interval = setInterval(() => {
            fetch(`/task/status/${taskId}`)
            .then(response => {
                if (response.status === 404) {
                    throw new Error('Task not found. It might have been cleared from memory.');
                }
                if (!response.ok) {
                    throw new Error('Could not get task status.');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'completed' || data.status === 'failed') {
                    clearInterval(interval);
                    loadingOverlay.style.display = 'none';
                    const toastTitle = data.status === 'completed' ? 'Success' : 'Failed';
                    const toastBody = data.status === 'completed' ? (data.description || 'Task') + ' completed successfully.' : data.error || 'An unknown error occurred.';
                    const toastClass = data.status === 'completed' ? 'success' : 'danger';
                    showToast(toastTitle, toastBody, toastClass);
                    
                    // Reload the page after a short delay to show the new results
                    setTimeout(() => location.reload(), 2500);
                }
            })
            .catch(error => {
                console.error('Error polling status:', error);
                clearInterval(interval);
                loadingOverlay.style.display = 'none';
                showToast('Polling Error', error.message, 'danger');
            });
        }, 3000); // Poll every 3 seconds
    }
});
</script>
{% endblock %} 