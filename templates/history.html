{% extends 'layout.html' %}

{% block title %}History for {{ website.name }} - Website Monitor{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* Add custom styles for the history page here */
    .history-table th, .history-table td {
        vertical-align: middle;
    }
    .screenshot-thumbnail {
        max-width: 200px;
        height: auto;
        border-radius: 5px;
        cursor: pointer;
        transition: transform 0.2s;
    }
    .screenshot-thumbnail:hover {
        transform: scale(1.05);
    }
    .baseline-gallery {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
    }
    .baseline-item {
        text-align: center;
    }
    .baseline-item .screenshot-thumbnail {
        max-width: 150px;
    }
    .modal-dialog-centered {
        display: flex;
        align-items: center;
        min-height: calc(100% - 1rem);
    }
    .modal-lg {
        max-width: 80%;
    }
    .modal-body img {
        max-width: 100%;
        height: auto;
    }
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 9999;
    }
    .loading-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 1.2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="h3">History for {{ website.name }}</h1>
        <p class="text-muted">
            View the monitoring history and run manual checks for {{ website.url }}.
        </p>
    </div>
    <div class="col-auto">
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>

<!-- Manual Check Controls -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="card-title mb-0">
            <i class="bi bi-play-circle"></i> Manual Checks
        </h5>
    </div>
    <div class="card-body">
        <div class="d-grid gap-2">
            <button class="btn btn-primary" id="checkNowBtn" data-check-type="full" data-website-id="{{ website.id }}">
                <i class="bi bi-play-circle"></i> Run Full Check Now
            </button>
            
            <div class="btn-group">
                <button class="btn btn-outline-secondary" id="visualCheckBtn" data-check-type="visual" data-website-id="{{ website.id }}">
                    <i class="bi bi-eye"></i> Visual Check Only
                </button>
                <button class="btn btn-outline-secondary" id="crawlCheckBtn" data-check-type="crawl" data-website-id="{{ website.id }}">
                    <i class="bi bi-search"></i> Crawl Check Only
                </button>
                <button class="btn btn-outline-secondary" id="blurCheckBtn" data-check-type="blur" data-website-id="{{ website.id }}">
                    <i class="bi bi-image"></i> Blur Check Only
                </button>
                <button class="btn btn-outline-secondary" id="performanceCheckBtn" data-check-type="performance" data-website-id="{{ website.id }}">
                    <i class="bi bi-speedometer2"></i> Performance Check
                </button>
                <button class="btn btn-outline-success" id="createBaselineBtn" data-check-type="baseline" data-website-id="{{ website.id }}">
                    <i class="bi bi-camera"></i> Create/Update Baseline
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Website Information -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Website Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Details</h6>
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <th>Website Name</th>
                                    <td>{{ website.name }}</td>
                                </tr>
                                <tr>
                                    <th>URL</th>
                                    <td><a href="{{ website.url }}" target="_blank">{{ website.url }}</a></td>
                                </tr>
                                <tr>
                                    <th>Status</th>
                                    <td>
                                        {% if website.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Check Interval</th>
                                    <td>{{ website.interval }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Last Check</h6>
                        <p class="text-muted">
                            {% if website.last_checked_utc %}
                                {{ website.last_checked_utc | humanize_datetime }}
                            {% else %}
                                Never checked
                            {% endif %}
                        </p>
                        
                        <h6>Next Check</h6>
                        <p class="text-muted">
                            {% if website.next_check_utc %}
                                {{ website.next_check_utc | humanize_datetime }}
                            {% else %}
                                Not scheduled
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('website_edit', site_id=website.id) }}" class="btn btn-outline-primary">
                        <i class="bi bi-pencil"></i> Edit Website
                    </a>
                    
                    {% if history %}
                    <a href="#historySection" class="btn btn-outline-info">
                        <i class="bi bi-clock-history"></i> View Change History
                    </a>
                    {% endif %}
                    
                    <a href="{{ url_for('website_summary', site_id=website.id) }}" class="btn btn-outline-primary">
                        <i class="bi bi-bar-chart"></i> View Site Summary
                    </a>
                    
                    <hr>
                    <h6 class="text-muted mb-2">View Results</h6>
                    
                    <div class="btn-group w-100 mb-2">
                        <a href="{{ url_for('website_crawler', site_id=website.id) }}" class="btn btn-outline-info">
                            <i class="bi bi-search"></i> Crawl Results
                        </a>
                        <a href="{{ url_for('website_missing_meta_tags', site_id=website.id) }}" class="btn btn-outline-warning">
                            <i class="bi bi-tags"></i> Meta Tags
                        </a>
                    </div>
                    
                    <div class="btn-group w-100">
                        {% if website.auto_blur_enabled or website.enable_blur_detection %}
                        <a href="{{ url_for('website_blur_detection', site_id=website.id) }}" class="btn btn-outline-secondary">
                            <i class="bi bi-image"></i> Blur Results
                        </a>
                        {% endif %}
                        {% if website.auto_performance_enabled %}
                        <a href="{{ url_for('website_performance', site_id=website.id) }}" class="btn btn-outline-success">
                            <i class="bi bi-speedometer2"></i> Performance
                        </a>
                        {% endif %}
                    </div>
                    
                    {% if website.baseline_visual_path %}
                    <hr>
                    <a href="#baselineSection" class="btn btn-outline-success">
                        <i class="bi bi-image"></i> View Baselines
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% if website.baseline_visual_path %}
<div class="card mb-4" id="baselineSection">
    <div class="card-header bg-light">
        <h5 class="card-title mb-0">
            <i class="bi bi-camera"></i> Visual Baselines
        </h5>
    </div>
    <div class="card-body">
        <div class="baseline-gallery">
            {% for baseline in website.baseline_visual_path %}
            <div class="baseline-item">
                <img src="{{ baseline.url }}" alt="{{ baseline.page }}" class="screenshot-thumbnail" data-bs-toggle="modal" data-bs-target="#screenshotModal" data-src="{{ baseline.url }}" data-page="{{ baseline.page }}">
                <div class="mt-2">
                    <small class="text-muted">{{ baseline.page }}</small>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- History Section -->
<div class="card" id="historySection">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="bi bi-clock-history"></i> Check History
        </h5>
    </div>
    <div class="card-body">
        {% if history %}
        <div class="table-responsive">
            <table class="table table-striped history-table">
                <thead>
                    <tr>
                        <th>Date & Time</th>
                        <th>Check Type</th>
                        <th>Status</th>
                        <th>Duration</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in history %}
                    <tr>
                        <td>{{ entry.timestamp | humanize_datetime }}</td>
                        <td>
                            <span class="badge bg-info">{{ entry.check_type }}</span>
                        </td>
                        <td>
                            {% if entry.status == 'success' %}
                                <span class="badge bg-success">Success</span>
                            {% elif entry.status == 'failed' %}
                                <span class="badge bg-danger">Failed</span>
                            {% else %}
                                <span class="badge bg-warning">{{ entry.status }}</span>
                            {% endif %}
                        </td>
                        <td>{{ entry.duration or 'N/A' }}</td>
                        <td>
                            {% if entry.details %}
                                <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#detailsModal" data-details="{{ entry.details }}">
                                    <i class="bi bi-info-circle"></i> View
                                </button>
                            {% else %}
                                <span class="text-muted">No details</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center text-muted py-4">
            <i class="bi bi-clock-history" style="font-size: 3rem;"></i>
            <p class="mt-3">No history available for this website yet.</p>
            <p>Run a manual check to start monitoring this website.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Screenshot Modal -->
<div class="modal fade" id="screenshotModal" tabindex="-1" aria-labelledby="screenshotModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="screenshotModalLabel">Screenshot Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalScreenshot" src="" alt="" class="img-fluid">
                <p id="modalPageInfo" class="mt-2 text-muted"></p>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Check Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre id="modalDetails" class="bg-light p-3 rounded"></pre>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay">
    <div class="loading-spinner">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-2">Processing check...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Screenshot modal functionality
    const screenshotModal = document.getElementById('screenshotModal');
    const modalScreenshot = document.getElementById('modalScreenshot');
    const modalPageInfo = document.getElementById('modalPageInfo');
    
    screenshotModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const screenshotSrc = button.getAttribute('data-src');
        const pageInfo = button.getAttribute('data-page');
        
        modalScreenshot.src = screenshotSrc;
        modalPageInfo.textContent = pageInfo;
    });
    
    // Details modal functionality
    const detailsModal = document.getElementById('detailsModal');
    const modalDetails = document.getElementById('modalDetails');
    
    detailsModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const details = button.getAttribute('data-details');
        
        modalDetails.textContent = details;
    });
    
    // Toast notification function
    function showToast(title, message, type) {
        const toastContainer = document.getElementById('toast-container') || createToastContainer();
        const toastId = 'toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">${title}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
        
        toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
        });
    }
    
    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
        return container;
    }
    
    // Manual check buttons now use the queue system via data attributes
    // The queue-manager.js handles all the click events and polling updates
    // Old JavaScript event listeners have been removed to prevent conflicts
});
</script>
{% endblock %}
